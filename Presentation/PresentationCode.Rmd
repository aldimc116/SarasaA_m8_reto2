---
title: "Presentación: Salud y Felicidad percibida en Europa"
author: "Alba Sarasa Gracia"
date: "01/09/2025"
output:
  ioslides_presentation:
    widescreen: true 
    smaller: true 
    transition: faster 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.align = "center")

# Definir el repositorio CRAN para instalar paquetes
options(repos = c(CRAN = "https://cloud.r-project.org"))

# Paquetes necesarios
packages <- c("knitr", "ggplot2", "dplyr", "ggridges", "viridis", 
              "readr", "here", "scales", "patchwork", "tidyr", "patchwork", "gt")

# Instalar automáticamente SOLO si faltan
installed <- packages %in% rownames(installed.packages())
  if (any(!installed)) { install.packages(packages[!installed]) }

# Cargar librerías
lapply(packages, library, character.only = TRUE)

# Cargar dataset
df <- read_csv(here("Data", "ESS11-depurado.csv"))


# Correlación de Spearman para happy y health
spearman_happy_health <- cor.test(as.numeric(df$happy), as.numeric(df$health), method = "spearman", use = "pairwise.complete.obs")
rho_hh <- spearman_happy_health$estimate
p_hh <- spearman_happy_health$p.value
```

## 1. Introducción

Este informe forma parte del proyecto de Ciencia de Datos reproducible del Máster en Behavioral Data Science (IL3 - UB).

### Objetivo principal:

#### Analizar algunos de los factores sociodemográficos y contextuales que influyen en la felicidad y la salud autopercibidas en Europa, con el fin de identificar patrones y relaciones relevantes.

------------------------------------------------------------------------

### Objetivos específicos:

-   **Observar diferencias internacionales:** Comparar la distribución geográfica de la salud y la felicidad autopercibida en Europa.
-   **Explorar relaciones entre variables:** Explorar la relación entre salud y felicidad autopercibida.
-   **Analizar la dimensión etaria:** Examinar cómo se relaciona la edad con los niveles de felicidad y de salud reportados.
-   **Estudiar la dimensión de género:** Identificar si existen diferencias de género en los niveles de felicidad percibida y de salud.
-   **Considerar la condición migratoria:** Determinar si la población nacida fuera del país reporta distintos niveles de felicidad y de salud respecto a la población nativa.

## 2. Datos y metodología

Los análisis se basan en los datos de la encuesta European Social Survey “ESS11 edition 3.0”, descargados el 20/08/2025.

Se han seleccionado las variables de:

-   felicidad (`happy`)

-   salud (`health`)

-   edad (`agea`)

-   género (`gndr`)

-   lugar de nacimiento (`brncntr`).

Los análisis combinan tablas resumen, pruebas estadísticas y gráficos descriptivos.

## 3. Resultados principales

### 3.1. Relación entre salud autopercibida y felicidad

```{r heatmap-correlation, fig.height=4, out.width="70%"}
# Calcular proporciones por combinación happy x health
df_heatmap <- df %>%
  filter(!is.na(happy) & !is.na(health)) %>%
  count(health, happy) %>%
  group_by(health) %>%
  mutate(prop = n / sum(n))

# Calcular tendencia: media de happy por cada nivel de health
trend <- df %>%
  filter(!is.na(happy) & !is.na(health)) %>%
  group_by(health) %>%
  summarise(mean_happy = mean(as.numeric(happy), na.rm = TRUE))

# Heatmap con tendencia
ggplot(df_heatmap, aes(x = health, y = happy, fill = prop)) + 
  geom_tile(color = "white", alpha = 0.9) +
  scale_fill_gradient(low = "lightblue", high = "darkblue") +
  geom_text(aes(label = scales::percent(prop, accuracy = 1)), color = "white", size = 3) +
  geom_line(
    data = trend,
    aes(x = health, y = mean_happy, group = 1), 
    color = "red", size = 1,
    inherit.aes = FALSE
  ) +
  geom_point(
    data = trend,
    aes(x = health, y = mean_happy),
    color = "red", size = 2,
    inherit.aes = FALSE
  ) +
  labs(
    x = "Salud autopercibida",
    y = "Felicidad autopercibida",
    fill = "Proporción",
    title = "Mapa de calor: Salud vs Felicidad"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))
```

Relación monótona inversa y estadísticamente significativa entre salud y felicidad percibidas.

------------------------------------------------------------------------

### 3.1. Relación entre salud autopercibida y felicidad

```{r heatmap-correlation2,  fig.height=4, out.width="50%"}

# Tabla de correlación
resultado_tabla <- data.frame(
  p_value = spearman_happy_health$p.value,
  rho = spearman_happy_health$estimate
)
knitr::kable(resultado_tabla, digits = 3,
             caption = "Test de correlación de Spearman entre salud y felicidad")
```

La mayoría de las respuestas se concentran en los valores de salud medio-bajos y de felicidad medio-altos.

------------------------------------------------------------------------

### 3.2. Interacción con factores sociodemográficos

#### Edad

```{r age-ridges, fig.height=4, out.width="70%"}
# --- HAPPY ---
df_ridges <- df %>%
  filter(!is.na(happy) & !is.na(agea)) %>%
  mutate(
    age_group = cut(agea, breaks = seq(15, 90, by = 5), include.lowest = TRUE, right = FALSE),
    happy_numeric = as.numeric(happy)
  )

trend1 <- df_ridges %>%
  group_by(age_group) %>%
  summarise(mean_happy = mean(happy_numeric),
            mid_age_pos = as.numeric(factor(age_group))) 

p1 <- ggplot(df_ridges, aes(x = happy_numeric, y = age_group, fill = stat(x))) +
  geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01) +
  geom_point(data = trend1, aes(x = mean_happy, y = age_group, color = "Felicidad media"), size = 2) +
  geom_smooth(data = trend1, aes(x = mean_happy, y = mid_age_pos, color = "Felicidad media"),
              method = "loess", se = FALSE, linewidth = 1) +
  scale_fill_viridis_c(option = "plasma", guide = guide_colorbar(direction = "horizontal", barwidth = 8, barheight = 0.5), alpha = 0.9,
                       name = "Nivel") +
  scale_x_continuous(breaks = 0:10, limits = c(0, 11)) +
  scale_color_manual(values = c("Felicidad media" = "red")) +
  labs(x = "Felicidad (0-10)", y = "Rango de edad", color = "", fill = "") +
  ggtitle("Distribución de felicidad por rangos de edad") +
  theme_minimal() +
  theme(plot.title = element_text(size = 12, hjust = 0.5),
        legend.position = "bottom", legend.box = "horizontal",
        legend.text = element_text(size = 8),
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"))

# --- HEALTH ---
df_ridges2 <- df %>%
  filter(!is.na(health) & !is.na(agea)) %>%
  mutate(
    age_group = cut(agea, breaks = seq(15, 90, by = 5), include.lowest = TRUE, right = FALSE),
    health_numeric = as.numeric(health) 
  )

trend2 <- df_ridges2 %>%
  group_by(age_group) %>%
  summarise(mean_health = mean(health_numeric),
            mid_age_pos = as.numeric(factor(age_group)))

p2 <- ggplot(df_ridges2, aes(x = health_numeric, y = age_group, fill = stat(x))) +
  geom_density_ridges_gradient(scale = 2, rel_min_height = 0.01) +
  geom_point(data = trend2, aes(x = mean_health, y = age_group, color = "Salud media"), size = 2) +
  geom_smooth(data = trend2, aes(x = mean_health, y = mid_age_pos, color = "Salud media"),
              method = "loess", se = FALSE, linewidth = 1) +
  scale_fill_viridis_c(option = "plasma", guide = guide_colorbar(direction = "horizontal", barwidth = 8, barheight = 0.5),
                       name = "Nivel") +
  scale_x_continuous(breaks = 1:5, limits = c(0.5, 5.5)) +
  scale_color_manual(values = c("Salud media" = "red")) +
  labs(x = "Salud (1-5)", y = "Rango de edad", color = "", fill = "") +
  ggtitle("Distribución de salud por rangos de edad") +
  theme_minimal() +
  theme(plot.title = element_text(size = 12, hjust = 0.5),
        legend.position = "bottom", legend.box = "horizontal",
        legend.text = element_text(size = 8),
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"))

# --- JUNTARLOS LADO A LADO ---
p1 + p2 +
  plot_annotation(title = "Distribución de felicidad y salud por rangos de edad") &
  theme(plot.title = element_text(size = 14, hjust = 0.5)) 
```

Se observa una tendencia a puntuar más bajo en felicidad pero más alto en salud percibida cuanto mayor es el rango de edad, lo que sigue el patrón inverso entre ambas variables.

------------------------------------------------------------------------

#### Género

```{r gender-plots, fig.height=6, fig.width=12, out.width="100%"}

# Plot 1: Salud por género
df_prop4 <- df %>%
  filter(!is.na(gndr) & !is.na(health)) %>%
  group_by(gndr, health) %>%
  summarise(n = n(), .groups = 'drop') %>%
  group_by(gndr) %>%
  mutate(prop = n / sum(n))

p_gender_health <- ggplot(df_prop4, aes(x = gndr, y = prop, fill = factor(health))) + 
  geom_bar(stat = "identity", position = "fill", color = "white") +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_fill_viridis_d(option = "plasma", name = "Nivel de salud percibida") +
  labs(x = "Género", y = "Proporción",
       title = "Distribución de salud por género") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 12),
    legend.position = "bottom",
    legend.title = element_text(size = 8),
    legend.text = element_text(size = 7),
    axis.text.x = element_text(size = 9),
    axis.title.x = element_text(size = 10),
    axis.text.y = element_text(size = 8),
    axis.title.y = element_text(size = 10)
  )

# Plot 2: Felicidad por género
df_prop3 <- df %>%
  filter(!is.na(happy) & !is.na(gndr)) %>%
  group_by(gndr, happy) %>%
  summarise(n = n(), .groups = 'drop') %>%
  group_by(gndr) %>%
  mutate(prop = n / sum(n))

p_gender_happy <- ggplot(df_prop3, aes(x = gndr, y = prop, fill = factor(happy))) + 
  geom_bar(stat = "identity", position = "fill", color = "white") +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_fill_viridis_d(option = "plasma", name = "Nivel de felicidad percibida") +
  labs(x = "Género", y = "Proporción",
       title = "Distribución de felicidad por género") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 12),
    legend.position = "bottom",
    legend.title = element_text(size = 8),
    legend.text = element_text(size = 7),
    axis.text.x = element_text(size = 9),
    axis.title.x = element_text(size = 10),
    axis.text.y = element_text(size = 8),
    axis.title.y = element_text(size = 10)
  )

# Combinar
p_gender_health + p_gender_happy +
  plot_annotation(title = "Distribución de felicidad y salud por género") &
  theme(plot.title = element_text(hjust = 0.5, size = 14))
```

Aunque existen ligeras diferencias en los niveles altos de felicidad y salud entre hombres y mujeres, la distribución general es bastante similar entre ambos géneros.

------------------------------------------------------------------------

#### Condición migratoria

```{r birth-plots, fig.height=6, fig.width=12, out.width="100%"}
# Plot 1: Felicidad por condición migratoria
df_prop1 <- df %>%
filter(!is.na(happy) & !is.na(brncntr)) %>%
group_by(brncntr, happy) %>%
summarise(n = n(), .groups = 'drop') %>%
group_by(brncntr) %>%
mutate(prop = n / sum(n))

p_birth_happy <- ggplot(df_prop1, aes(x = brncntr, y = prop, fill = factor(happy))) + 
geom_bar(stat = "identity", position = "fill", color = "white") +
scale_y_continuous(labels = scales::percent_format()) +
scale_fill_viridis_d(option = "plasma", alpha = 0.9, name = "Nivel de felicidad percibida") +
labs(x = "Origen", y = "Proporción",
title = "Distribución de felicidad por origen") +
theme_minimal() +
theme(
plot.title = element_text(hjust = 0.5, size = 12),
legend.position = "bottom",
legend.title = element_text(size = 8),
legend.text = element_text(size = 7),
axis.text.x = element_text(size = 9),
axis.title.x = element_text(size = 10),
axis.text.y = element_text(size = 8),
axis.title.y = element_text(size = 10)
)

# Plot 2: Salud por condición migratoria
df_prop2 <- df %>%
filter(!is.na(brncntr) & !is.na(health)) %>%
group_by(brncntr, health) %>%
summarise(n = n(), .groups = 'drop') %>%
group_by(brncntr) %>%
mutate(prop = n / sum(n))

p_birth_health <- ggplot(df_prop2, aes(x = brncntr, y = prop, fill = factor(health))) +
geom_bar(stat = "identity", position = "fill", color = "white") +
scale_y_continuous(labels = scales::percent_format()) +
scale_fill_viridis_d(option = "plasma", name = "Nivel de salud percibida") +
labs(x = "Origen", y = "Proporción",
title = "Distribución de salud por origen") +
theme_minimal() +
theme(
plot.title = element_text(hjust = 0.5, size = 12),
legend.position = "bottom",
legend.title = element_text(size = 8),
legend.text = element_text(size = 7),
axis.text.x = element_text(size = 9),
axis.title.x = element_text(size = 10),
axis.text.y = element_text(size = 8),
axis.title.y = element_text(size = 10)
)

# Combinar
p_birth_happy + p_birth_health +
plot_annotation(title = "Distribución de felicidad y salud por condición migratoria") &
theme(plot.title = element_text(hjust = 0.5, size = 14))
```

La población no nacida en el país tiende a reportar niveles más altos de felicidad, mientras que la población nativa puntúa más alto en salud percibida.

## 4. Conclusiones

-   **Relación entre salud y felicidad:** Se ha detectado una tendencia monótona negativa: a menor salud media percibida, mayor felicidad media reportada. La mayoría de las respuestas se concentran en los valores de salud medio-bajos y de felicidad medio-altos.
-   **Relación entre edad y felicidad/salud:** La felicidad tiende a disminuir ligeramente con la edad, mientras que la salud percibida aumenta, reforzando la relación inversa entre ambas variables.
-   **Diferencias de género en felicidad y salud:** Las diferencias entre hombres y mujeres son sutiles; las mujeres puntúan ligeramente más alto en niveles altos de felicidad y salud, pero las distribuciones generales son similares.
-   **Condición migratoria y niveles de felicidad/salud:** Las personas no nacidas en el país muestran mayor proporción en niveles altos de felicidad, mientras que las personas nacidas en el país puntúan más alto en salud. Esto confirma la relación inversa observada entre felicidad y salud percibida, también controlando por este factor.
