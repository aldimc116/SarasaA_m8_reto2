---
title: "Informe t√©cnico: Salud y Felicidad percibida en Europa"
author: "Alba Sarasa Gracia"
date: "01/09/2025"
output: html_document
---

```{r setup, include=FALSE}

### SETUP:
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

# Definir el repositorio CRAN para instalar paquetes 
options(repos = c(CRAN = "<https://cloud.r-project.org>"))

# Paquetes necesarios

packages <- c("knitr","flexdashboard", "ggplot2", "dplyr", "ggridges", "viridis", "plotly", "readr", "here", "shiny", "sf", "rnaturalearth","ggridges","patchwork")

# Instalar autom√°ticamente si faltan

installed <- packages %in% rownames(installed.packages()) 
  if (any(!installed)) { install.packages(packages[!installed]) }

# Cargar librer√≠as y dataset

lapply(packages, library, character.only = TRUE)
df <- read.csv(here("Data", "ESS11-depurado.csv"))
```

# 1. Introducci√≥n

Este informe forma parte del proyecto de Ciencia de Datos reproducible del M√°ster en Behavioral Data Science por el Instituto de Formaci√≥n Continua IL3 de la Universidad de Barcelona.\
El objetivo principal es **analizar algunos de los factores sociodemogr√°ficos y contextuales que influyen en la felicidad y la salud autopercibidas en Europa**, con el fin de identificar patrones y relaciones relevantes.

Los objetivos espec√≠ficos del proyecto son:

-   **Observar diferencias internacionales:** Comparar la distribuci√≥n geogr√°fica de la salud y la felicidad autopercibida.

-   **Explorar relaciones entre variables:** Explorar la relaci√≥n entre salud y felicidad autopercibida.

-   **Analizar la dimensi√≥n etaria:** Examinar c√≥mo se relaciona la edad con los niveles de felicidad y de salud reportados.

-   **Estudiar la dimensi√≥n de g√©nero:** Identificar si existen diferencias de g√©nero en los niveles de felicidad percibida y de salud.

-   **Considerar la condici√≥n migratoria:** Determinar si la poblaci√≥n nacida fuera del pa√≠s reporta distintos niveles de felicidad y de salud respecto a la poblaci√≥n nativa.

# 2. Datos y metodolog√≠a

Los an√°lisis se basan en los datos de la encuesta [European Social Survey](https://ess.sikt.no/en/) ‚ÄúESS11 edition 3.0‚Äù, descargados el 20/08/2025.

Se han seleccionado las variables de felicidad (`happy`), salud (`health`), edad (`agea`), g√©nero (`gndr`), y lugar de nacimiento (`brncntr`).\
Los an√°lisis combinan **tablas resumen, pruebas estad√≠sticas y gr√°ficos descriptivos**.

# 3. Resultados principales

## 3.1. Relaci√≥n entre salud autopercibida y felicidad

```{r echo=FALSE}
# Calcular proporciones por combinaci√≥n happy x health
df_heatmap <- df %>%
  filter(!is.na(happy) & !is.na(health)) %>%
  count(health, happy) %>%
  group_by(health) %>%
  mutate(prop = n / sum(n))

# Calcular tendencia: media de happy por cada nivel de health
trend <- df %>%
  filter(!is.na(happy) & !is.na(health)) %>%
  group_by(health) %>%
  summarise(mean_happy = mean(happy, na.rm = TRUE))

# Heatmap con tendencia
ggplot(df_heatmap, aes(x = as.numeric(health), y = as.numeric(happy), fill = prop)) +
  geom_tile(color = "white", alpha = 0.9) +
  scale_fill_gradient(low = "lightblue", high = "darkblue") +
  geom_text(aes(label = scales::percent(prop, accuracy = 1)), color = "white", size = 3) +
  geom_line(
    data = trend,
    aes(x = as.numeric(health), y = mean_happy),
    color = "red", size = 1,
    inherit.aes = FALSE
  ) +
  geom_point(
    data = trend,
    aes(x = as.numeric(health), y = mean_happy),
    color = "red", size = 2,
    inherit.aes = FALSE
  ) +
  labs(
    x = "Salud autopercibida",
    y = "Felicidad autopercibida",
    fill = "Proporci√≥n",
    title = "Figura 1. Mapa de calor: Salud vs Felicidad"
  ) +
  scale_x_continuous(breaks = unique(as.numeric(df$health))) +
  scale_y_continuous(breaks = unique(as.numeric(df$happy))) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

Se observan diferencias notables entre pa√≠ses en los niveles de felicidad autopercibida: podemos ver una cierta tendencia a tener una felicidad media m√°s alta en los pa√≠ses que muestran valores de salud bajos. Esto sugiere una relaci√≥n inversa enter ambas variables.

```{r}
# Spearman correlation con test
spearman_happy_health <- cor.test(df$happy, df$health, method = "spearman", use = "pairwise.complete.obs")
resultado_tabla <- data.frame(
  p_value = spearman_happy_health$p.value,
  rho = spearman_happy_health$estimate
)

knitr::kable(resultado_tabla, digits = 3,
             caption = "Tabla 1. Test de correlaci√≥n de Spearman entre health y happy")
```

Como se puede observar en la Tabla 1, el test de correlaci√≥n de Spearman confirma la relaci√≥n mon√≥tona inversa entre ambas variables.

## 3.2. Interacci√≥n con factores sociodemogr√°ficos: 

Se exploran m√°s a fondo estas variables mediante el an√°lisis conjunto con factores sociodemogr√°ficos como la edad, el g√©nero y la situaci√≥n de inmigaci√≥n.

```{r echo=FALSE, fig.width=10, out.width="100%"}

# --- HAPPY ---
df_ridges <- df %>%
  filter(!is.na(happy) & !is.na(agea)) %>%
  mutate(age_group = cut(agea, breaks = seq(15, 90, by = 5), include.lowest = TRUE))

trend1 <- df_ridges %>%
  group_by(age_group) %>%
  summarise(mean_happy = mean(happy),
            mid_age = mean(as.numeric(age_group)))

p1 <- ggplot(df_ridges, aes(x = happy, y = age_group, fill = stat(x))) +
  geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01) +
  geom_point(data = trend1, aes(x = mean_happy, y = age_group, color = "Felicidad media"), size = 2) +
  geom_smooth(data = trend1, aes(x = mean_happy, y = as.numeric(age_group), color = "Felicidad media"),
              method = "loess", se = FALSE, linewidth = 1) +
  scale_fill_viridis_c(option = "plasma", guide = guide_colorbar(direction = "horizontal"), alpha = 0.9) +
  scale_x_continuous(breaks = 0:10, limits = c(0, 11)) +
  scale_color_manual(values = c("Felicidad media" = "red")) +
  labs(x = "Felicidad", y = "Rango de edad", fill = "Felicidad", color = "") +
  ggtitle("Distribuci√≥n de felicidad por rangos de edad") +
  theme_minimal() +
  theme(plot.title = element_text(size = 12),  # üîπ tama√±o m√°s peque√±o
    axis.text.y = element_text(size = 10),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(size = 10),
    axis.title.x = element_text(size = 12),
    legend.text = element_text(size = 8),
    legend.position = "bottom",
    legend.box = "horizontal"
  )

# --- HEALTH ---
df_ridges2 <- df %>%
  filter(!is.na(health) & !is.na(agea)) %>%
  mutate(age_group = cut(agea, breaks = seq(15, 90, by = 5), include.lowest = TRUE))

trend2 <- df_ridges2 %>%
  group_by(age_group) %>%
  summarise(mean_health = mean(health),
            mid_age = mean(as.numeric(age_group)))

p2 <- ggplot(df_ridges2, aes(x = health, y = age_group, fill = stat(x))) +
  geom_density_ridges_gradient(scale = 2, rel_min_height = 0.00001) +
  geom_point(data = trend2, aes(x = mean_health, y = age_group, color = "Salud media"), size = 2) +
  geom_smooth(data = trend2, aes(x = mean_health, y = as.numeric(age_group), color = "Salud media"),
              method = "loess", se = FALSE, linewidth = 1) +
  scale_fill_viridis_c(option = "plasma", guide = guide_colorbar(direction = "horizontal")) +
  scale_x_continuous(breaks = 0:5, limits = c(0, 5.5)) +
  scale_color_manual(values = c("Salud media" = "red")) +
  labs(x = "Salud", y = "Rango de edad", fill = "Salud", color = "") +
  ggtitle("Distribuci√≥n de salud por rangos de edad") +
  theme_minimal() +
  theme(plot.title = element_text(size = 12),  # üîπ tama√±o m√°s peque√±o
    axis.text.y = element_text(size = 10),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(size = 10),
    axis.title.x = element_text(size = 12),
    legend.text = element_text(size = 8),
    legend.position = "bottom",
    legend.box = "horizontal"
  )

# --- JUNTARLOS LADO A LADO ---
p1 + p2 +
  plot_annotation(title = "Figura 2. Distribuci√≥n de felicidad y salud por rangos de edad")

```

Respecto a la edad, el gr√°fico (Figura 1) muestra una tendencia a puntuar m√°s bajo en felicidad pero m√°s alto en salud percibida cuanto mayor es el rango de edad, lo que sigue el patr√≥n inverso entre ambas variables que se ha descrito anteriormente.

En las tablas siguientes (Tabla 2 y Tabla 3) se observa que, aunque existen ligeras diferencias en los niveles altos de felicidad y salud entre hombres y mujeres, la distribuci√≥n general es bastante similar entre ambos g√©neros.

```{r echo=FALSE}
# Tabla de felicidad por g√©nero (%)
tabla_feliz_genero <- prop.table(table(df$happy, df$gndr), margin = 2) * 100
tabla_feliz_genero <- round(tabla_feliz_genero, 2)

# Tabla de salud por g√©nero (%)
tabla_salud_genero <- prop.table(table(df$health, df$gndr), margin = 2) * 100
tabla_salud_genero <- round(tabla_salud_genero, 2)

# Mostrar tablas
kable(tabla_feliz_genero, caption = "Tabla 2. Distribuci√≥n porcentual de felicidad por g√©nero")  
kable(tabla_salud_genero, caption = "Tabla 3. Distribuci√≥n porcentual de salud por g√©nero")
```

Finalmente, se muestra a continuaci√≥n (Tabla 4 y Tabla 5) que la poblaci√≥n no nacida en el pa√≠s tiende a reportar niveles m√°s altos de felicidad, mientras que la poblaci√≥n nativa punt√∫a m√°s alto en salud percibida. Esto refuerza la hip√≥tesis de una relaci√≥n inversa entre salud y felicidad percibidas.

```{r echo=FALSE}
## Diferencias de g√©nero en felicidad y salud

# Tabla de felicidad por condici√≥n migratoria (%)
tabla_feliz_migracion <- prop.table(table(df$happy, df$brncntr), margin = 2) * 100
tabla_feliz_migracion <- round(tabla_feliz_migracion, 2)

# Tabla de salud por condici√≥n migratoria (%)
tabla_salud_migracion <- prop.table(table(df$health, df$brncntr), margin = 2) * 100
tabla_salud_migracion <- round(tabla_salud_migracion, 2)

kable(tabla_feliz_migracion, caption = "Tabla 4. Distribuci√≥n porcentual de felicidad por condici√≥n migratoria")
kable(tabla_salud_migracion, caption = "Tabla 5. Distribuci√≥n porcentual de salud por condici√≥n migratoria")

```

# 4. Conclusiones

**Relaci√≥n entre salud y felicidad:**

Se ha detectado una tendencia mon√≥tona negativa: a menor salud media percibida, mayor

felicidad media reportada. La mayor√≠a de las respuestas se concentran en los valores de salud medio-bajos y de felicidad medio-altos.

**Relaci√≥n entre edad y felicidad/salud:**

La felicidad tiende a disminuir ligeramente con la edad, mientras que la salud percibida aumenta, reforzando la relaci√≥n inversa entre ambas variables.

**Diferencias de g√©nero en felicidad y salud:**

Las diferencias entre hombres y mujeres son sutiles; las mujeres punt√∫an ligeramente m√°s alto en niveles altos de felicidad y salud, pero las distribuciones generales son similares.

**Condici√≥n migratoria y niveles de felicidad/salud:**

Las personas no nacidas en el pa√≠s muestran mayor proporci√≥n en niveles altos de felicidad, mientras que las personas nacidas en el pa√≠s punt√∫an m√°s alto en salud. Esto confirma la relaci√≥n inversa observada entre felicidad y salud percibida.
